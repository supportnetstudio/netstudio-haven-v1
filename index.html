<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>The Haven — Powered by Net Studio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    window.nsOpenBooking = window.nsOpenBooking || function(payload = {}) {
      if (window.NetStudio && typeof window.NetStudio.open === "function") return window.NetStudio.open(payload);
      console.warn("Booking engine loading...");
    };
  </script>

  <style>
    /* --- CORE VARIABLES --- */
    :root {
      --bg-body: #FDFBF7;
      --bg-alt: #F3EFE7;
      --text-main: #3D3A36;
      --text-muted: #8C8680;
      --accent: #B08968;
      --font-heading: 'Playfair Display', serif;
      --font-body: 'Lato', sans-serif;
    }

    /* --- RESET --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg-body);
      color: var(--text-main);
      font-family: var(--font-body);
      line-height: 1.7;
      overflow-x: hidden;
    }

    h1, h2, h3 { font-family: var(--font-heading); font-weight: 400; color: #2C2926; }
    h1 { font-size: clamp(42px, 6vw, 72px); line-height: 1.1; margin-bottom: 24px; }
    h2 { font-size: 36px; margin-bottom: 20px; }
    
    .subtitle {
      font-family: var(--font-body); font-size: 11px; letter-spacing: 0.2em; 
      text-transform: uppercase; color: var(--accent); display: block; margin-bottom: 16px;
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 0 40px; }
    .section-pad { padding: 80px 0; }
    
    @media(max-width: 768px) {
      .container { padding: 0 20px; }
      .section-pad { padding: 60px 0; }
    }
    
    .btn {
      display: inline-block; background: #2C2926; color: white;
      padding: 14px 32px; border-radius: 50px; text-decoration: none;
      font-size: 13px; letter-spacing: 0.05em; transition: 0.3s;
      cursor: pointer; border: none;
    }
    .btn:hover { background: var(--accent); transform: translateY(-2px); }
    
    .btn-outline {
      background: transparent; border: 1px solid #2C2926; color: #2C2926;
    }
    .btn-outline:hover { background: #2C2926; color: white; border-color: #2C2926; }

    nav { padding: 30px 40px; display: flex; justify-content: space-between; align-items: center; }
    .logo { font-family: var(--font-heading); font-size: 24px; font-weight: 600; letter-spacing: -0.02em; font-style: italic; }
    .nav-links { display: flex; gap: 40px; }
    .nav-links a { color: var(--text-main); text-decoration: none; font-size: 14px; }
    
    @media(max-width: 768px) { 
      nav { padding: 20px; }
      .nav-links { display: none; } 
    }

    .hero {
      display: grid; grid-template-columns: 1fr 1fr; gap: 60px; align-items: center;
      min-height: 80vh; padding-bottom: 60px;
    }
    .hero-img-wrap {
      width: 100%; height: 80vh; border-radius: 200px 200px 0 0; overflow: hidden; position: relative;
    }
    .hero-img { width: 100%; height: 100%; object-fit: cover; }
    
    .hero-badge {
      position: absolute; bottom: 40px; background: white; padding: 24px;
      border-radius: 0 12px 12px 0; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      left: -40px;
    }

    @media(max-width: 768px) { 
      .hero { grid-template-columns: 1fr; gap: 40px; padding-top: 20px; }
      .hero-img-wrap { height: 450px; order: -1; border-radius: 12px; }
      .hero-badge { left: 0; bottom: 20px; padding: 16px 20px; }
    }

    .svc-scroll {
      display: flex; gap: 20px; overflow-x: auto; padding-bottom: 40px;
      padding-left: 20px; margin: 0 -20px;
      scrollbar-width: none;
    }
    .svc-scroll::-webkit-scrollbar { display: none; }
    .svc-card {
      min-width: 280px; background: white; padding: 30px; border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.03); transition: 0.3s;
      margin-top: 10px;
    }
    .svc-card:hover { transform: translateY(-5px); box-shadow: 0 20px 50px rgba(0,0,0,0.06); }

    .about-section { background: var(--bg-alt); border-radius: 24px; overflow: hidden; }
    .about-grid { display: grid; grid-template-columns: 1fr 1fr; }
    .about-content { padding: 80px; display: flex; flex-direction: column; justify-content: center; }
    .about-img { width: 100%; height: 100%; object-fit: cover; }
    
    @media(max-width: 768px) { 
      .about-grid { grid-template-columns: 1fr; }
      .about-content { padding: 40px 24px; }
      .about-img { height: 250px; }
    }

    .quote-box { text-align: center; max-width: 800px; margin: 0 auto; padding: 0 20px; }
    .quote-text { font-family: var(--font-heading); font-size: 28px; font-style: italic; color: var(--accent); margin-bottom: 20px; }

    footer { padding: 80px 0 40px; text-align: center; color: var(--text-muted); font-size: 13px; border-top: 1px solid #eee; }

    #site-error { display: none; text-align: center; padding: 100px 20px; color: #666; font-size: 14px; }
  </style>
</head>
<body id="home">

  <div id="site-error">
    <h2>404</h2>
    <p>We couldn't find a sanctuary at this address.</p>
  </div>

  <div id="main-content">
    <nav>
      <div class="logo" id="nav_logo">The Haven</div>
      <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="services.html">Services</a>
        <a href="about.html">Our Story</a>
        <a href="contact.html">Contact</a>
      </div>
      <a href="#book" class="btn" onclick="nsOpenBooking(); return false;" style="padding: 12px 24px;">Book</a>
    </nav>

    <header class="container hero">
      <div class="hero-text">
        <span id="hero_kicker" class="subtitle"></span>
        <h1 id="hero_headline"></h1>
        <p id="hero_subheadline" style="color:var(--text-muted); margin-bottom: 40px; max-width: 450px;"></p>
        <div style="display:flex; gap: 16px; flex-wrap: wrap;">
          <a href="#book" class="btn" onclick="nsOpenBooking(); return false;">Book Now</a>
          <a href="services.html" class="btn btn-outline">View Menu</a>
        </div>
      </div>
      
      <div class="hero-img-wrap">
        <img id="hero_img" src="" class="hero-img">
        <div class="hero-badge">
          <div id="rating_value" style="font-family: var(--font-heading); font-size: 32px;"></div>
          <div id="rating_label" style="font-size: 11px; text-transform: uppercase; color: var(--text-muted);"></div>
        </div>
      </div>
    </header>

    <section class="container section-pad">
      <div style="text-align: center; margin-bottom: 40px;">
        <span id="services_kicker" class="subtitle"></span>
        <h2 id="services_title"></h2>
      </div>
      <div class="svc-scroll" id="service_preview">
        </div>
    </section>

    <section class="container section-pad">
      <div class="about-section">
        <div class="about-grid">
          <img id="intro_img" src="" class="about-img">
          <div class="about-content">
            <span id="intro_kicker" class="subtitle"></span>
            <h2 id="intro_headline"></h2>
            <p id="intro_body" style="color:var(--text-muted); margin-bottom: 30px;"></p>
            <a id="intro_cta" href="about.html" style="color: var(--accent); text-decoration: none; font-weight: 700; font-size: 14px;"></a>
          </div>
        </div>
      </div>
    </section>

    <section class="container section-pad">
      <div class="quote-box">
        <div id="testimonial_quote" class="quote-text"></div>
        <div id="testimonial_author" style="font-size: 13px; font-weight: 700;"></div>
        <div id="testimonial_attribution" style="font-size: 12px; color: var(--text-muted);"></div>
      </div>
    </section>

    <footer>
      <div class="container">
        <div id="footer_logo" style="font-family: var(--font-heading); font-size: 24px; margin-bottom: 20px;">The Haven</div>
        <p id="ns_address" style="margin-bottom: 10px;"></p>
        <p id="footer_copy">&copy; 2026 The Haven. Powered by Net Studio.</p>
      </div>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    (() => {
      const $ = (id) => document.getElementById(id);
      const pick = (...vals) => vals.find(v => v !== undefined && v !== null && String(v).trim() !== "") || "";

      function nsDetectSlugProdOnly() {
        const ROOT = "netstudiodevelopment.com";
        const host = (location.hostname || "").toLowerCase();
        if (!host || host === ROOT || host === "www." + ROOT) return null;
        if (!host.endsWith("." + ROOT)) return null;
        const prefix = host.slice(0, -(ROOT.length + 1));
        if (!prefix || prefix.includes(".")) return null;
        return prefix.trim();
      }

      // ✅ PATCH 1: Global Config Exposure
      const NS = {
        SB_URL: "https://jdvdgvolfmvlgyfklbwe.supabase.co",
        SB_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpkdmRndm9sZm12bGd5ZmtsYndlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1Mjk5MDgsImV4cCI6MjA3OTEwNTkwOH0.xiAOgWof9En3jbCpY1vrYpj3HD-O6jMHbamIHTSflek",
        SLUG: nsDetectSlugProdOnly(),
        FALLBACK_TEMPLATE: "haven_v1"
      };

      // ✅ PATCH 2: True 404 Isolation
      function show404(){
        const e = document.getElementById("site-error");
        const m = document.getElementById("main-content");
        if (e) e.style.display = "block";
        if (m) m.style.display = "none";
      }

      const sb = supabase.createClient(NS.SB_URL, NS.SB_KEY);

      function nsLoadBookingEngine() {
        return new Promise((resolve) => {
          if (window.NetStudio && typeof window.NetStudio.open === "function") return resolve(true);
          const s = document.createElement("script");
          s.src = "/netstudio_booking.js";
          s.async = true;
          s.onload = () => resolve(true);
          s.onerror = () => resolve(false);
          document.body.appendChild(s);
        });
      }

      function apply(data, biz) {
        const home = data.home || {};
        const hero = home.hero || {};
        const intro = home.intro || {};
        const services = home.services || {};
        const testimonial = home.testimonial || {};

        const bName = biz.name || "The Haven";
        if ($("nav_logo")) $("nav_logo").textContent = bName;
        if ($("footer_logo")) $("footer_logo").textContent = bName;
        if ($("footer_copy")) $("footer_copy").innerHTML = `&copy; ${new Date().getFullYear()} ${bName}. Powered by Net Studio.`;

        if ($("hero_kicker")) $("hero_kicker").textContent = pick(hero.kicker, "Welcome to The Haven");
        if ($("hero_headline")) $("hero_headline").innerHTML = pick(hero.headline, "Beauty, Rooted<br>In Nature.");
        if ($("hero_subheadline")) $("hero_subheadline").textContent = pick(hero.subheadline, biz.bio, "A sanctuary for hair and soul.");
        
        // ✅ PATCH 4: Normalized Hero Image Keys
        if ($("hero_img")) $("hero_img").src = pick(
          hero.bg, 
          hero.image_url, 
          hero.bg_image, 
          biz.hero_bg_url, 
          "https://images.unsplash.com/photo-1595476108010-b4d1f102b1b1?auto=format&fit=crop&q=80&w=1200"
        );
        
        if ($("rating_value")) $("rating_value").textContent = pick(hero.rating?.value, hero.rating_value, "4.9");
        if ($("rating_label")) $("rating_label").textContent = pick(hero.rating?.label, hero.rating_label, "Average Rating");

        if ($("services_kicker")) $("services_kicker").textContent = pick(services.kicker, "Our Expertise");
        if ($("services_title")) $("services_title").textContent = pick(services.title, "Curated Services");

        if ($("intro_kicker")) $("intro_kicker").textContent = pick(intro.kicker, "The Philosophy");
        if ($("intro_headline")) $("intro_headline").textContent = pick(intro.headline, "Intention in Every Detail.");
        if ($("intro_body")) $("intro_body").textContent = pick(intro.body, "We believe a salon visit should be a restoration.");
        if ($("intro_img")) $("intro_img").src = pick(intro.image, "https://images.unsplash.com/photo-1633681926022-84c23e8cb2d6?auto=format&fit=crop&q=80&w=1200");
        if ($("intro_cta")) $("intro_cta").textContent = pick(intro.cta_text, "Read Our Story →");

        if ($("testimonial_quote")) $("testimonial_quote").textContent = pick(testimonial.quote, "I have never felt more heard by a stylist.");
        if ($("testimonial_author")) $("testimonial_author").textContent = pick(testimonial.author, "Sarah Jenkins");
        
        if ($("testimonial_attribution")) $("testimonial_attribution").textContent = pick(testimonial.date, testimonial.attribution, "Client since 2021");

        // ✅ PATCH 5: Normalized Address Source
        if ($("ns_address")) {
          $("ns_address").innerHTML = pick(
            biz.address_html, 
            [biz.street_address, biz.city, biz.state].filter(Boolean).join(", ")
          );
        }

        if (window.lucide) lucide.createIcons();
      }

      async function init() {
        if (!NS.SLUG) { show404(); return; }

        const { data: biz } = await sb.from("business").select("*").eq("slug", NS.SLUG).maybeSingle();
        if (!biz) { show404(); return; }

        // ✅ PATCH 1: Identity Exposure
        window.NS_BUSINESS_ID = biz.id;
        document.documentElement.setAttribute("data-ns-business-id", String(biz.id));
        
        // IDENTITY LOCK: Fetch Pointer
        const { data: pointer } = await sb.from("business_sites_one").select("active_template_key").eq("business_id", biz.id).maybeSingle();
        const activeKey = pointer?.active_template_key || NS.FALLBACK_TEMPLATE;

        nsLoadBookingEngine(); // Non-blocking

        const [siteRes, menuRes] = await Promise.all([
          sb.from("business_sites").select("content_json").eq("business_id", biz.id).eq("template_key", activeKey).maybeSingle(),
          sb.from("menu_items").select("*").eq("business_id", biz.id).eq("is_active", true).limit(3)
        ]);

        // ✅ PATCH 6: Console Warning for Missing Row
        if (!siteRes.data) {
          console.warn(`[NetStudio] Missing business_sites row: template=${activeKey}, business_id=${biz.id}`);
        }

        const scroll = $("service_preview");
        if (scroll && menuRes.data && menuRes.data.length > 0) {
          scroll.innerHTML = menuRes.data.map(s => `
            <div class="svc-card">
              <h3 style="font-size: 22px; margin-bottom: 10px;">${s.name}</h3>
              <p style="font-size: 14px; color: var(--text-muted); margin-bottom: 20px;">${s.description || "Custom service."}</p>
              <span style="font-size: 12px; font-weight: 700; border-bottom: 1px solid black; padding-bottom: 4px;">$${(s.price_cents/100).toFixed(0)}+</span>
            </div>
          `).join("");
        } else if (scroll) {
           scroll.innerHTML = ""; // Clear loader if no data
        }

        apply(siteRes.data?.content_json || {}, biz);
      }
      
      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>
